
from datasets.MarioBadescu import MarioBadescu
            
from datasets.FableMane import FableMane
            
from datasets.goop import goop
            
from datasets.TheMaker import TheMaker
            
from datasets.JIMMYCHOO import JIMMYCHOO
            
from datasets.RalphLauren import RalphLauren
            
from datasets.Gucci import Gucci
            
from datasets.JVN import JVN
            
from datasets.Clarins import Clarins
            
from datasets.Evian import Evian
            
from datasets.GlowRecipe import GlowRecipe
            
from datasets.MelaninHaircare import MelaninHaircare
            
from datasets.ViktorRolf import ViktorRolf
            
from datasets.FORVRMood import FORVRMood
            
from datasets.AtelierCologne import AtelierCologne
            
from datasets.FaceGym import FaceGym
            
from datasets.LauraMercier import LauraMercier
            
from datasets.CANOPY import CANOPY
            
from datasets.SephoraFavorites import SephoraFavorites
            
from datasets.YvesSaintLaurent import YvesSaintLaurent
            
from datasets.MoonJuice import MoonJuice
            
from datasets.ArmaniBeauty import ArmaniBeauty
            
from datasets.TheOrdinary import TheOrdinary
            
from datasets.Mugler import Mugler
            
from datasets.EllisBrooklyn import EllisBrooklyn
            
from datasets.CLINIQUE import CLINIQUE
            
from datasets.PROVENSkincare import PROVENSkincare
            
from datasets.CalvinKlein import CalvinKlein
            
from datasets.ROSEINC import ROSEINC
            
from datasets.ArtistCouture import ArtistCouture
            
from datasets.Aquis import Aquis
            
from datasets.Kaja import Kaja
            
from datasets.iNNBEAUTYPROJECT import iNNBEAUTYPROJECT
            
from datasets.EightBob import EightBob
            
from datasets.NaturallySerious import NaturallySerious
            
from datasets.Tabu import Tabu
            
from datasets.Sourse import Sourse
            
from datasets.dae import dae
            
from datasets.maude import maude
            
from datasets.DERMAFLASH import DERMAFLASH
            
from datasets.Versace import Versace
            
from datasets.FloralStreet import FloralStreet
            
from datasets.Susteau import Susteau
            
from datasets.Skinfix import Skinfix
            
from datasets.DanessaMyricksBeauty import DanessaMyricksBeauty
            
from datasets.PeaceOut import PeaceOut
            
from datasets.SkinLaundry import SkinLaundry
            
from datasets.Tower28Beauty import Tower28Beauty
            
from datasets.YouthToThePeople import YouthToThePeople
            
from datasets.GXVEBYGWENSTEFANI import GXVEBYGWENSTEFANI
            
from datasets.Supergoop import Supergoop
            
from datasets.LOrealProfessionnel import LOrealProfessionnel
            
from datasets.Lancome import Lancome
            
from datasets.DrDennisGrossSkincare import DrDennisGrossSkincare
            
from datasets.DUO import DUO
            
from datasets.WorldofChrisCollins import WorldofChrisCollins
            
from datasets.HERETIC import HERETIC
            
from datasets.DOMINIQUECOSMETICS import DOMINIQUECOSMETICS
            
from datasets.Caudalie import Caudalie
            
from datasets.TOCCA import TOCCA
            
from datasets.BASMA import BASMA
            
from datasets.CiateLondon import CiateLondon
            
from datasets.RareBeautybySelenaGomez import RareBeautybySelenaGomez
            
from datasets.Herbivore import Herbivore
            
from datasets.MeltCosmetics import MeltCosmetics
            
from datasets.KiehlsSince1851 import KiehlsSince1851
            
from datasets.ChristopheRobin import ChristopheRobin
            
from datasets.MARA import MARA
            
from datasets._54Thrones import _54Thrones
            
from datasets.CharlotteTilbury import CharlotteTilbury
            
from datasets.FashionFair import FashionFair
            
from datasets.BenefitCosmetics import BenefitCosmetics
            
from datasets.NAILSINC import NAILSINC
            
from datasets.StriVectin import StriVectin
            
from datasets.Shiseido import Shiseido
            
from datasets.KVDBeauty import KVDBeauty
            
from datasets.NuFACE import NuFACE
            
from datasets.Biossance import Biossance
            
from datasets.FentySkin import FentySkin
            
from datasets.StTropez import StTropez
            
from datasets.Tatcha import Tatcha
            
from datasets.Virtue import Virtue
            
from datasets.LillyLashes import LillyLashes
            
from datasets.Smashbox import Smashbox
            
from datasets.TheOutset import TheOutset
            
from datasets.ABBOTT import ABBOTT
            
from datasets.KILIANParis import KILIANParis
            
from datasets.Azzaro import Azzaro
            
from datasets.Ceremonia import Ceremonia
            
from datasets.Blinc import Blinc
            
from datasets.Commodity import Commodity
            
from datasets.SoldeJaneiro import SoldeJaneiro
            
from datasets.MERIT import MERIT
            
from datasets.WestmanAtelier import WestmanAtelier
            
from datasets.Dior import Dior
            
from datasets.NatashaDenona import NatashaDenona
            
from datasets.BURBERRY import BURBERRY
            
from datasets.FloraBast import FloraBast
            
from datasets.PATMcGRATHLABS import PATMcGRATHLABS
            
from datasets.RANAVAT import RANAVAT
            
from datasets.FirstAidBeauty import FirstAidBeauty
            
from datasets.IsleofParadise import IsleofParadise
            
from datasets.fresh import fresh
            
from datasets.PATRICKTA import PATRICKTA
            
from datasets.BoySmells import BoySmells
            
from datasets.KateSomerville import KateSomerville
            
from datasets.Montblanc import Montblanc
            
from datasets.REFY import REFY
            
from datasets.Slip import Slip
            
from datasets.LoveShackFancy import LoveShackFancy
            
from datasets.ALTERNAHaircare import ALTERNAHaircare
            
from datasets.BonParfumeur import BonParfumeur
            
from datasets.WASO import WASO
            
from datasets.TOMFORD import TOMFORD
            
from datasets.Stripes import Stripes
            
from datasets.JosieMaran import JosieMaran
            
from datasets.MangoPeople import MangoPeople
            
from datasets.HERMES import HERMES
            
from datasets.HigherDOSE import HigherDOSE
            
from datasets.PHLUR import PHLUR
            
from datasets.stila import stila
            
from datasets.SharkBeauty import SharkBeauty
            
from datasets.K18BiomimeticHairscience import K18BiomimeticHairscience
            
from datasets.SUNDAYIISUNDAY import SUNDAYIISUNDAY
            
from datasets.The7Virtues import The7Virtues
            
from datasets.Rabanne import Rabanne
            
from datasets.JLoBeauty import JLoBeauty
            
from datasets.Buxom import Buxom
            
from datasets.OLEHENRIKSEN import OLEHENRIKSEN
            
from datasets.HAUSLABSBYLADYGAGA import HAUSLABSBYLADYGAGA
            
from datasets.T3 import T3
            
from datasets.Viseart import Viseart
            
from datasets.KORAOrganics import KORAOrganics
            
from datasets.Saie import Saie
            
from datasets.MountLai import MountLai
            
from datasets.SaintJaneBeauty import SaintJaneBeauty
            
from datasets.NARS import NARS
            
from datasets.SEPHORACOLLECTION import SEPHORACOLLECTION
            
from datasets.VOLUSPA import VOLUSPA
            
from datasets.VioletVoss import VioletVoss
            
from datasets.shuuemura import shuuemura
            
from datasets.Pureology import Pureology
            
from datasets.Oribe import Oribe
            
from datasets.PaulasChoice import PaulasChoice
            
from datasets.SoleilToujours import SoleilToujours
            
from datasets.JouerCosmetics import JouerCosmetics
            
from datasets.MaisonMargiela import MaisonMargiela
            
from datasets.AcquadiParma import AcquadiParma
            
from datasets.Gisou import Gisou
            
from datasets.Prima import Prima
            
from datasets.TheNueCo import TheNueCo
            
from datasets.FunctionofBeautyPRO import FunctionofBeautyPRO
            
from datasets.Vegamour import Vegamour
            
from datasets.HABIT import HABIT
            
from datasets.ghd import ghd
            
from datasets.TheOriginalMakeUpEraser import TheOriginalMakeUpEraser
            
from datasets.SmileMakers import SmileMakers
            
from datasets.Glamnetic import Glamnetic
            
from datasets.BioIonic import BioIonic
            
from datasets.OUIthePeople import OUIthePeople
            
from datasets.DrBarbaraSturm import DrBarbaraSturm
            
from datasets.Olaplex import Olaplex
            
from datasets.KateMcLeod import KateMcLeod
            
from datasets._1969 import _1969
            
from datasets.INCredible import INCredible
            
from datasets.SKII import SKII
            
from datasets.SIMIHAZEBEAUTY import SIMIHAZEBEAUTY
            
from datasets.CrownAffair import CrownAffair
            
from datasets.Hanni import Hanni
            
from datasets.philosophy import philosophy
            
from datasets.GUERLAIN import GUERLAIN
            
from datasets.Briogeo import Briogeo
            
from datasets.LaMer import LaMer
            
from datasets.NUDESTIX import NUDESTIX
            
from datasets.Kopari import Kopari
            
from datasets.PeterThomasRoth import PeterThomasRoth
            
from datasets.GLOScience import GLOScience
            
from datasets.Chloe import Chloe
            
from datasets.Algenist import Algenist
            
from datasets.Glossier import Glossier
            
from datasets.belif import belif
            
from datasets.DrZenoviaSkincare import DrZenoviaSkincare
            
from datasets.PATTERNbyTraceeEllisRoss import PATTERNbyTraceeEllisRoss
            
from datasets.Necessaire import Necessaire
            
from datasets.LAWLESS import LAWLESS
            
from datasets.DrLaraDevganScientificBeauty import DrLaraDevganScientificBeauty
            
from datasets.RosebudPerfumeCo import RosebudPerfumeCo
            
from datasets.Kulfi import Kulfi
            
from datasets.JoMaloneLondon import JoMaloneLondon
            
from datasets.AugustinusBader import AugustinusBader
            
from datasets.MILKMAKEUP import MILKMAKEUP
            
from datasets.RossanoFerrettiParma import RossanoFerrettiParma
            
from datasets.PMD import PMD
            
from datasets._5SENS import _5SENS
            
from datasets.Viori import Viori
            
from datasets.Kosas import Kosas
            
from datasets.CinemaSecrets import CinemaSecrets
            
from datasets.IconicLondon import IconicLondon
            
from datasets.Verb import Verb
            
from datasets.WanderBeauty import WanderBeauty
            
from datasets.DAMDAM import DAMDAM
            
from datasets.BeautyBio import BeautyBio
            
from datasets.Moroccanoil import Moroccanoil
            
from datasets.Drybar import Drybar
            
from datasets.LOccitane import LOccitane
            
from datasets.HUDABEAUTY import HUDABEAUTY
            
from datasets.LOrealProfessionnelSteampod import LOrealProfessionnelSteampod
            
from datasets.AERIN import AERIN
            
from datasets.Kerastase import Kerastase
            
from datasets.Topicals import Topicals
            
from datasets.EsteeLauder import EsteeLauder
            
from datasets.ciele import ciele
            
from datasets.AnastasiaBeverlyHills import AnastasiaBeverlyHills
            
from datasets.Curlsmith import Curlsmith
            
from datasets.Givenchy import Givenchy
            
from datasets.BREADBEAUTYSUPPLY import BREADBEAUTYSUPPLY
            
from datasets.TooFaced import TooFaced
            
from datasets.TULASkincare import TULASkincare
            
from datasets.COOLA import COOLA
            
from datasets.GrandeCosmetics import GrandeCosmetics
            
from datasets.Murad import Murad
            
from datasets.LANEIGE import LANEIGE
            
from datasets.HouseofLashes import HouseofLashes
            
from datasets.DrBrandtSkincare import DrBrandtSkincare
            
from datasets.superzero import superzero
            
from datasets.ByRosieJane import ByRosieJane
            
from datasets.ShaniDardenSkinCare import ShaniDardenSkinCare
            
from datasets.CHANEL import CHANEL
            
from datasets.JuicyCouture import JuicyCouture
            
from datasets.EADEM import EADEM
            
from datasets.Sulwhasoo import Sulwhasoo
            
from datasets.caliray import caliray
            
from datasets.MaisonLouisMarie import MaisonLouisMarie
            
from datasets.beautyblender import beautyblender
            
from datasets.UrbanDecay import UrbanDecay
            
from datasets.CommunitySixtySix import CommunitySixtySix
            
from datasets.KAYALI import KAYALI
            
from datasets.BobbiBrown import BobbiBrown
            
from datasets.amika import amika
            
from datasets.TWEEZERMAN import TWEEZERMAN
            
from datasets.Reverie import Reverie
            
from datasets.innisfree import innisfree
            
from datasets.DeborahLippmann import DeborahLippmann
            
from datasets.Wishful import Wishful
            
from datasets.Bumbleandbumble import Bumbleandbumble
            
from datasets.adwoabeauty import adwoabeauty
            
from datasets.JillianDempsey import JillianDempsey
            
from datasets.DolceGabbana import DolceGabbana
            
from datasets.TheINKEYList import TheINKEYList
            
from datasets.KORRES import KORRES
            
from datasets.NurseJamie import NurseJamie
            
from datasets.NESTNewYork import NESTNewYork
            
from datasets.ONESIZEbyPatrickStarrr import ONESIZEbyPatrickStarrr
            
from datasets.ILIA import ILIA
            
from datasets.HyperSkin import HyperSkin
            
from datasets.JulietteHasaGun import JulietteHasaGun
            
from datasets.LivingProof import LivingProof
            
from datasets.LYSBeauty import LYSBeauty
            
from datasets.AmiCole import AmiCole
            
from datasets.TANLUXE import TANLUXE
            
from datasets.AlphaH import AlphaH
            
from datasets.CLEANRESERVE import CLEANRESERVE
            
from datasets.RIES import RIES
            
from datasets.Rahua import Rahua
            
from datasets.BondiBoost import BondiBoost
            
from datasets.SundayRiley import SundayRiley
            
from datasets.Touchland import Touchland
            
from datasets.COLORWOW import COLORWOW
            
from datasets.SKYLAR import SKYLAR
            
from datasets.FentyBeautybyRihanna import FentyBeautybyRihanna
            
from datasets.MAKEUPFOREVER import MAKEUPFOREVER
            
from datasets.DrJart import DrJart
            
from datasets.LunaDaily import LunaDaily
            
from datasets.tarte import tarte
            
from datasets.MAKEUPBYMARIO import MAKEUPBYMARIO
            
from datasets.MACRENEactives import MACRENEactives
        
from datasets.Valentino import Valentino
        
from datasets.IGK import IGK
        
from datasets.OTHERLAND import OTHERLAND
        
from datasets.bareMinerals import bareMinerals
        
from datasets.TataHarper import TataHarper
        
from datasets.ActAcre import ActAcre
        
from datasets.Nette import Nette
        
from datasets.Hourglass import Hourglass
        
from datasets.DonnaKaran import DonnaKaran
        
from datasets.Nutrafol import Nutrafol
        
from datasets.DrunkElephant import DrunkElephant
        
from datasets.HenryRose import HenryRose
        
from datasets.MarcJacobsFragrances import MarcJacobsFragrances
        
from datasets.ITCosmetics import ITCosmetics
        
from datasets.LionPose import LionPose
                
from datasets.SHAZKIKS import SHAZKIKS
        
from datasets.JackBlack import JackBlack
        
from datasets.RENCleanSkincare import RENCleanSkincare
        
from datasets.MATTEROFFACT import MATTEROFFACT
        
from datasets.Dyson import Dyson
        
from datasets.GraceEleyae import GraceEleyae
        
from datasets.Overose import Overose
        
from datasets.FOREO import FOREO
        
from datasets.Dermalogica import Dermalogica
        
from datasets.OUAI import OUAI
        
from datasets.CAYSKIN import CAYSKIN
        
from datasets.Mizani import Mizani
        
from datasets.Origins import Origins
        
from datasets.SOBELSKINRx import SOBELSKINRx
        
from datasets.SummerFridays import SummerFridays
        
from datasets.ALO import ALO
        
from datasets.Prada import Prada
        
from datasets.FreckBeauty import FreckBeauty
        
from datasets.DedCool import DedCool
        
from datasets.VelourLashes import VelourLashes
        
from datasets.Farmacy import Farmacy
        
from datasets.alpynbeauty import alpynbeauty
        
from datasets.CarolinaHerrera import CarolinaHerrera
        
from datasets.ROSEIngletonMD import ROSEIngletonMD
        
        

from GenerateFeatures_test import GenerateFeatures
import os
import random
import argparse
import yaml
from tqdm import tqdm

import torch
import torch.nn.functional as F
import torch.nn as nn
import torchvision.transforms as transforms

# from datasets import build_dataset
# from datasets.utils import build_data_loader
import clip
from utils import *

import matplotlib.pyplot as plt
from PIL import Image
import csv


def get_arguments():
    parser = argparse.ArgumentParser()
    parser.add_argument('--class_name', type=str, help='Name of new class name')
    # parser.add_argument('--inference_type', type=str, help='Type of inference')
    
    args = parser.parse_args()
    return args


def test(cfg, cache_keys, cache_values, test_features, clip_weights):
    print("\n-------- Evaluating on the test set. --------")
    adapter = torch.load(cfg['cache_dir'] + "/APE-T_" + str(cfg['shots']) + "shots.pt")
    with torch.no_grad():
        new_cache_keys, new_clip_weights, R_FW = adapter(cache_keys, clip_weights, cache_values)
        
        R_fF = test_features @ new_cache_keys.half().t()
        cache_logits = ((-1) * (cfg['best_beta'] - cfg['best_beta'] * R_fF)).exp() @ R_FW

        R_fW = 100. * test_features @ new_clip_weights
        ape_logits = R_fW + cache_logits * cfg['best_alpha']


        # 레이블 추론
        predicted_labels = torch.argmax(ape_logits, dim=1)

    # acc = cls_acc(ape_logits, test_labels)

    print("predicted label : ", predicted_labels)
    # print("**** APE-T's test accuracy: {:.2f}. ****\n".format(acc))
    
    
    
    
def main():
    args = get_arguments()
    cls = args.class_name
    
    clip_model, preprocess = clip.load('ViT-B/32')
    GenerateFeatures_ = GenerateFeatures(clip_model, preprocess, cls_name = cls)
    GenerateFeatures_.generate_features()
    
    cfg = yaml.load(open(f'configs/{cls}.yaml', 'r'), Loader = yaml.Loader)
    
    clip_model, _ = clip.load(cfg['backbone'])
    clip_model.eval()
    random.seed(cfg['seed']) 
    torch.manual_seed(cfg['seed'])
    clip_weights = load_text_feature(cfg)
    cache_keys, cache_values = load_few_shot_feature(cfg)
    test_features, _ = loda_val_test_feature(cfg, "test")
    
    test(cfg, cache_keys, cache_values, test_features, clip_weights)
    

if __name__ == '__main__':
    main()
