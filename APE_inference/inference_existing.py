# -*- coding: utf-8 -*-

from datasets_test.MarioBadescu import MarioBadescu

from datasets_test.FableMane import FableMane

from datasets_test.goop import goop

from datasets_test.TheMaker import TheMaker

from datasets_test.JIMMYCHOO import JIMMYCHOO

from datasets_test.RalphLauren import RalphLauren

from datasets_test.Gucci import Gucci

from datasets_test.JVN import JVN

from datasets_test.Clarins import Clarins

from datasets_test.Evian import Evian

from datasets_test.GlowRecipe import GlowRecipe

from datasets_test.MelaninHaircare import MelaninHaircare

from datasets_test.ViktorRolf import ViktorRolf

from datasets_test.FORVRMood import FORVRMood

from datasets_test.AtelierCologne import AtelierCologne

from datasets_test.FaceGym import FaceGym

from datasets_test.LauraMercier import LauraMercier

from datasets_test.CANOPY import CANOPY

from datasets_test.SephoraFavorites import SephoraFavorites

from datasets_test.YvesSaintLaurent import YvesSaintLaurent

from datasets_test.MoonJuice import MoonJuice

from datasets_test.ArmaniBeauty import ArmaniBeauty

from datasets_test.TheOrdinary import TheOrdinary

from datasets_test.Mugler import Mugler

from datasets_test.EllisBrooklyn import EllisBrooklyn

from datasets_test.CLINIQUE import CLINIQUE

from datasets_test.PROVENSkincare import PROVENSkincare

from datasets_test.CalvinKlein import CalvinKlein

from datasets_test.ROSEINC import ROSEINC

from datasets_test.ArtistCouture import ArtistCouture

from datasets_test.Aquis import Aquis

from datasets_test.Kaja import Kaja

from datasets_test.iNNBEAUTYPROJECT import iNNBEAUTYPROJECT

from datasets_test.EightBob import EightBob

from datasets_test.NaturallySerious import NaturallySerious

from datasets_test.Tabu import Tabu

from datasets_test.Sourse import Sourse

from datasets_test.dae import dae

from datasets_test.maude import maude

from datasets_test.DERMAFLASH import DERMAFLASH

from datasets_test.Versace import Versace

from datasets_test.FloralStreet import FloralStreet

from datasets_test.Susteau import Susteau

from datasets_test.Skinfix import Skinfix

from datasets_test.DanessaMyricksBeauty import DanessaMyricksBeauty

from datasets_test.PeaceOut import PeaceOut

from datasets_test.SkinLaundry import SkinLaundry

from datasets_test.Tower28Beauty import Tower28Beauty

from datasets_test.YouthToThePeople import YouthToThePeople

from datasets_test.GXVEBYGWENSTEFANI import GXVEBYGWENSTEFANI

from datasets_test.Supergoop import Supergoop

from datasets_test.LOrealProfessionnel import LOrealProfessionnel

from datasets_test.Lancome import Lancome

from datasets_test.DrDennisGrossSkincare import DrDennisGrossSkincare

from datasets_test.DUO import DUO

from datasets_test.WorldofChrisCollins import WorldofChrisCollins

from datasets_test.HERETIC import HERETIC

from datasets_test.DOMINIQUECOSMETICS import DOMINIQUECOSMETICS

from datasets_test.Caudalie import Caudalie

from datasets_test.TOCCA import TOCCA

from datasets_test.BASMA import BASMA

from datasets_test.CiateLondon import CiateLondon

from datasets_test.RareBeautybySelenaGomez import RareBeautybySelenaGomez

from datasets_test.Herbivore import Herbivore

from datasets_test.MeltCosmetics import MeltCosmetics

from datasets_test.KiehlsSince1851 import KiehlsSince1851

from datasets_test.ChristopheRobin import ChristopheRobin

from datasets_test.MARA import MARA

from datasets_test._54Thrones import _54Thrones

from datasets_test.CharlotteTilbury import CharlotteTilbury

from datasets_test.FashionFair import FashionFair

from datasets_test.BenefitCosmetics import BenefitCosmetics

from datasets_test.NAILSINC import NAILSINC

from datasets_test.StriVectin import StriVectin

from datasets_test.Shiseido import Shiseido

from datasets_test.KVDBeauty import KVDBeauty

from datasets_test.NuFACE import NuFACE

from datasets_test.Biossance import Biossance

from datasets_test.FentySkin import FentySkin

from datasets_test.StTropez import StTropez

from datasets_test.Tatcha import Tatcha

from datasets_test.Virtue import Virtue

from datasets_test.LillyLashes import LillyLashes

from datasets_test.Smashbox import Smashbox

from datasets_test.TheOutset import TheOutset

from datasets_test.ABBOTT import ABBOTT

from datasets_test.KILIANParis import KILIANParis

from datasets_test.Azzaro import Azzaro

from datasets_test.Ceremonia import Ceremonia

from datasets_test.Blinc import Blinc

from datasets_test.Commodity import Commodity

from datasets_test.SoldeJaneiro import SoldeJaneiro

from datasets_test.MERIT import MERIT

from datasets_test.WestmanAtelier import WestmanAtelier

from datasets_test.Dior import Dior

from datasets_test.NatashaDenona import NatashaDenona

from datasets_test.BURBERRY import BURBERRY

from datasets_test.FloraBast import FloraBast

from datasets_test.PATMcGRATHLABS import PATMcGRATHLABS

from datasets_test.RANAVAT import RANAVAT

from datasets_test.FirstAidBeauty import FirstAidBeauty

from datasets_test.IsleofParadise import IsleofParadise

from datasets_test.fresh import fresh

from datasets_test.PATRICKTA import PATRICKTA

from datasets_test.BoySmells import BoySmells

from datasets_test.KateSomerville import KateSomerville

from datasets_test.Montblanc import Montblanc

from datasets_test.REFY import REFY

from datasets_test.Slip import Slip

from datasets_test.LoveShackFancy import LoveShackFancy

from datasets_test.ALTERNAHaircare import ALTERNAHaircare

from datasets_test.BonParfumeur import BonParfumeur

from datasets_test.WASO import WASO

from datasets_test.TOMFORD import TOMFORD

from datasets_test.Stripes import Stripes

from datasets_test.JosieMaran import JosieMaran

from datasets_test.MangoPeople import MangoPeople

from datasets_test.HERMES import HERMES

from datasets_test.HigherDOSE import HigherDOSE

from datasets_test.PHLUR import PHLUR

from datasets_test.stila import stila

from datasets_test.SharkBeauty import SharkBeauty

from datasets_test.K18BiomimeticHairscience import K18BiomimeticHairscience

from datasets_test.SUNDAYIISUNDAY import SUNDAYIISUNDAY

from datasets_test.The7Virtues import The7Virtues

from datasets_test.Rabanne import Rabanne

from datasets_test.JLoBeauty import JLoBeauty

from datasets_test.Buxom import Buxom

from datasets_test.OLEHENRIKSEN import OLEHENRIKSEN

from datasets_test.HAUSLABSBYLADYGAGA import HAUSLABSBYLADYGAGA

from datasets_test.T3 import T3

from datasets_test.Viseart import Viseart

from datasets_test.KORAOrganics import KORAOrganics

from datasets_test.Saie import Saie

from datasets_test.MountLai import MountLai

from datasets_test.SaintJaneBeauty import SaintJaneBeauty

from datasets_test.NARS import NARS

from datasets_test.SEPHORACOLLECTION import SEPHORACOLLECTION

from datasets_test.VOLUSPA import VOLUSPA

from datasets_test.VioletVoss import VioletVoss

from datasets_test.shuuemura import shuuemura

from datasets_test.Pureology import Pureology

from datasets_test.Oribe import Oribe

from datasets_test.PaulasChoice import PaulasChoice

from datasets_test.SoleilToujours import SoleilToujours

from datasets_test.JouerCosmetics import JouerCosmetics

from datasets_test.MaisonMargiela import MaisonMargiela

from datasets_test.AcquadiParma import AcquadiParma

from datasets_test.Gisou import Gisou

from datasets_test.Prima import Prima

from datasets_test.TheNueCo import TheNueCo

from datasets_test.FunctionofBeautyPRO import FunctionofBeautyPRO

from datasets_test.Vegamour import Vegamour

from datasets_test.HABIT import HABIT

from datasets_test.ghd import ghd

from datasets_test.TheOriginalMakeUpEraser import TheOriginalMakeUpEraser

from datasets_test.SmileMakers import SmileMakers

from datasets_test.Glamnetic import Glamnetic

from datasets_test.BioIonic import BioIonic

from datasets_test.OUIthePeople import OUIthePeople

from datasets_test.DrBarbaraSturm import DrBarbaraSturm

from datasets_test.Olaplex import Olaplex

from datasets_test.KateMcLeod import KateMcLeod

from datasets_test._1969 import _1969

from datasets_test.INCredible import INCredible

from datasets_test.SKII import SKII

from datasets_test.SIMIHAZEBEAUTY import SIMIHAZEBEAUTY

from datasets_test.CrownAffair import CrownAffair

from datasets_test.Hanni import Hanni

from datasets_test.philosophy import philosophy

from datasets_test.GUERLAIN import GUERLAIN

from datasets_test.Briogeo import Briogeo

from datasets_test.LaMer import LaMer

from datasets_test.NUDESTIX import NUDESTIX

from datasets_test.Kopari import Kopari

from datasets_test.PeterThomasRoth import PeterThomasRoth

from datasets_test.GLOScience import GLOScience

from datasets_test.Chloe import Chloe

from datasets_test.Algenist import Algenist

from datasets_test.Glossier import Glossier

from datasets_test.belif import belif

from datasets_test.DrZenoviaSkincare import DrZenoviaSkincare

from datasets_test.PATTERNbyTraceeEllisRoss import PATTERNbyTraceeEllisRoss

from datasets_test.Necessaire import Necessaire

from datasets_test.LAWLESS import LAWLESS

from datasets_test.DrLaraDevganScientificBeauty import DrLaraDevganScientificBeauty

from datasets_test.RosebudPerfumeCo import RosebudPerfumeCo

from datasets_test.Kulfi import Kulfi

from datasets_test.JoMaloneLondon import JoMaloneLondon

from datasets_test.AugustinusBader import AugustinusBader

from datasets_test.MILKMAKEUP import MILKMAKEUP

from datasets_test.RossanoFerrettiParma import RossanoFerrettiParma

from datasets_test.PMD import PMD

from datasets_test._5SENS import _5SENS

from datasets_test.Viori import Viori

from datasets_test.Kosas import Kosas

from datasets_test.CinemaSecrets import CinemaSecrets

from datasets_test.IconicLondon import IconicLondon

from datasets_test.Verb import Verb

from datasets_test.WanderBeauty import WanderBeauty

from datasets_test.DAMDAM import DAMDAM

from datasets_test.BeautyBio import BeautyBio

from datasets_test.Moroccanoil import Moroccanoil

from datasets_test.Drybar import Drybar

from datasets_test.LOccitane import LOccitane

from datasets_test.HUDABEAUTY import HUDABEAUTY

from datasets_test.LOrealProfessionnelSteampod import LOrealProfessionnelSteampod

from datasets_test.AERIN import AERIN

from datasets_test.Kerastase import Kerastase

from datasets_test.Topicals import Topicals

from datasets_test.EsteeLauder import EsteeLauder

from datasets_test.ciele import ciele

from datasets_test.AnastasiaBeverlyHills import AnastasiaBeverlyHills

from datasets_test.Curlsmith import Curlsmith

from datasets_test.Givenchy import Givenchy

from datasets_test.BREADBEAUTYSUPPLY import BREADBEAUTYSUPPLY

from datasets_test.TooFaced import TooFaced

from datasets_test.TULASkincare import TULASkincare

from datasets_test.COOLA import COOLA

from datasets_test.GrandeCosmetics import GrandeCosmetics

from datasets_test.Murad import Murad

from datasets_test.LANEIGE import LANEIGE

from datasets_test.HouseofLashes import HouseofLashes

from datasets_test.DrBrandtSkincare import DrBrandtSkincare

from datasets_test.superzero import superzero

from datasets_test.ByRosieJane import ByRosieJane

from datasets_test.ShaniDardenSkinCare import ShaniDardenSkinCare

from datasets_test.CHANEL import CHANEL

from datasets_test.JuicyCouture import JuicyCouture

from datasets_test.EADEM import EADEM

from datasets_test.Sulwhasoo import Sulwhasoo

from datasets_test.caliray import caliray

from datasets_test.MaisonLouisMarie import MaisonLouisMarie

from datasets_test.beautyblender import beautyblender

from datasets_test.UrbanDecay import UrbanDecay

from datasets_test.CommunitySixtySix import CommunitySixtySix

from datasets_test.KAYALI import KAYALI

from datasets_test.BobbiBrown import BobbiBrown

from datasets_test.amika import amika

from datasets_test.TWEEZERMAN import TWEEZERMAN

from datasets_test.Reverie import Reverie

from datasets_test.innisfree import innisfree

from datasets_test.DeborahLippmann import DeborahLippmann

from datasets_test.Wishful import Wishful

from datasets_test.Bumbleandbumble import Bumbleandbumble

from datasets_test.adwoabeauty import adwoabeauty

from datasets_test.JillianDempsey import JillianDempsey

from datasets_test.DolceGabbana import DolceGabbana

from datasets_test.TheINKEYList import TheINKEYList

from datasets_test.KORRES import KORRES

from datasets_test.NurseJamie import NurseJamie

from datasets_test.NESTNewYork import NESTNewYork

from datasets_test.ONESIZEbyPatrickStarrr import ONESIZEbyPatrickStarrr

from datasets_test.ILIA import ILIA

from datasets_test.HyperSkin import HyperSkin

from datasets_test.JulietteHasaGun import JulietteHasaGun

from datasets_test.LivingProof import LivingProof

from datasets_test.LYSBeauty import LYSBeauty

from datasets_test.AmiCole import AmiCole

from datasets_test.TANLUXE import TANLUXE

from datasets_test.AlphaH import AlphaH

from datasets_test.CLEANRESERVE import CLEANRESERVE

from datasets_test.RIES import RIES

from datasets_test.Rahua import Rahua

from datasets_test.BondiBoost import BondiBoost

from datasets_test.SundayRiley import SundayRiley

from datasets_test.Touchland import Touchland

from datasets_test.COLORWOW import COLORWOW

from datasets_test.SKYLAR import SKYLAR

from datasets_test.FentyBeautybyRihanna import FentyBeautybyRihanna

from datasets_test.MAKEUPFOREVER import MAKEUPFOREVER

from datasets_test.DrJart import DrJart

from datasets_test.LunaDaily import LunaDaily

from datasets_test.tarte import tarte

from datasets_test.MAKEUPBYMARIO import MAKEUPBYMARIO

from datasets_test.MACRENEactives import MACRENEactives

from datasets_test.Valentino import Valentino

from datasets_test.IGK import IGK

from datasets_test.OTHERLAND import OTHERLAND

from datasets_test.bareMinerals import bareMinerals

from datasets_test.TataHarper import TataHarper

from datasets_test.ActAcre import ActAcre

from datasets_test.Nette import Nette

from datasets_test.Hourglass import Hourglass

from datasets_test.DonnaKaran import DonnaKaran

from datasets_test.Nutrafol import Nutrafol

from datasets_test.DrunkElephant import DrunkElephant

from datasets_test.HenryRose import HenryRose

from datasets_test.MarcJacobsFragrances import MarcJacobsFragrances

from datasets_test.ITCosmetics import ITCosmetics

from datasets_test.LionPose import LionPose

from datasets_test.SHAZKIKS import SHAZKIKS

from datasets_test.JackBlack import JackBlack

from datasets_test.RENCleanSkincare import RENCleanSkincare

from datasets_test.MATTEROFFACT import MATTEROFFACT

from datasets_test.Dyson import Dyson

from datasets_test.GraceEleyae import GraceEleyae

from datasets_test.Overose import Overose

from datasets_test.FOREO import FOREO

from datasets_test.Dermalogica import Dermalogica

from datasets_test.OUAI import OUAI

from datasets_test.CAYSKIN import CAYSKIN

from datasets_test.Mizani import Mizani

from datasets_test.Origins import Origins

from datasets_test.SOBELSKINRx import SOBELSKINRx

from datasets_test.SummerFridays import SummerFridays

from datasets_test.ALO import ALO

from datasets_test.Prada import Prada

from datasets_test.FreckBeauty import FreckBeauty

from datasets_test.DedCool import DedCool

from datasets_test.VelourLashes import VelourLashes

from datasets_test.Farmacy import Farmacy

from datasets_test.alpynbeauty import alpynbeauty

from datasets_test.CarolinaHerrera import CarolinaHerrera

from datasets_test.ROSEIngletonMD import ROSEIngletonMD
# -

from GenerateFeatures_test import GenerateFeatures
import os
import random
import argparse
import yaml
from tqdm import tqdm
import shutil
import boto3

import torch
import torch.nn.functional as F
import torch.nn as nn
import torchvision.transforms as transforms

import clip
from utils import *

import matplotlib.pyplot as plt
from PIL import Image
import csv

from flask import Flask, request, jsonify
from flask_cors import CORS


def get_arguments():
    parser = argparse.ArgumentParser()
    parser.add_argument('--class_name', type=str,
                        help='Name of new class name')
    # parser.add_argument('--inference_type', type=str, help='Type of inference')

    args = parser.parse_args()
    return args


def delete_ipynb():
    folder_path = './'
    for root, dirs, files in os.walk(folder_path):
        for directory in dirs[:]:
            if directory.startswith(".ipynb_checkpoints"):
                dir_path = os.path.join(root, directory)
                print(f"Deleting folder: {dir_path}")
                try:
                    os.rmdir(dir_path)
                except OSError as e:
                    print(f"Error deleting folder: {e}")


# +
def inference_class(cls, ans):

    # 파일을 읽어서 파싱
    file_path = f'./labels/{cls}.yaml'
    with open(file_path, 'r') as file:
        data = yaml.safe_load(file)

    # 0번 key에 해당하는 값을 가져오기
    value_at_label = data.get(ans)

#     print(value_at_label)

    return value_at_label


# +
def test(cfg, cache_keys, cache_values, test_features, clip_weights, cls):
    print("\n-------- Evaluating on the test set. --------")
    adapter = torch.load(cfg['cache_dir'] + "/APE-T_" +
                         str(cfg['shots']) + "shots.pt")

    with open('./params.yaml') as f:
        value = yaml.load(f, Loader=yaml.FullLoader)

    best_alpha = value[cls]['alpha']
    best_beta = value[cls]['beta']

    with torch.no_grad():
        new_cache_keys, new_clip_weights, R_FW = adapter(
            cache_keys, clip_weights, cache_values)

        R_fF = test_features @ new_cache_keys.half().t()
#         cache_logits = ((-1) * (cfg['best_beta'] - cfg['best_beta'] * R_fF)).exp() @ R_FW
        cache_logits = ((-1) * (best_beta - best_beta * R_fF)).exp() @ R_FW

        R_fW = 100. * test_features @ new_clip_weights
#         ape_logits = R_fW + cache_logits * cfg['best_alpha']
        ape_logits = R_fW + cache_logits * best_alpha

        # 레이블 추론
        predicted_labels = torch.argmax(ape_logits, dim=1)
        predicted_labels = predicted_labels.tolist()  # 텐서를 리스트로 변환
        predicted_labels = [str(label)
                            for label in predicted_labels]  # 리스트의 각 요소를 문자열로 변환
#         print("predicted label : ", predicted_labels)

        ans = inference_class(cls, int(predicted_labels.pop()))

#     acc = cls_acc(ape_logits, test_labels)

    print("predicted answer : ", ans)
    return predicted_labels
    # print("**** APE-T's test accuracy: {:.2f}. ****\n".format(acc))


def download_directory_from_s3(bucket_name, prefix, local_directory):
    s3 = boto3.client('s3')

    paginator = s3.get_paginator('list_objects_v2')
    for result in paginator.paginate(Bucket=bucket_name, Prefix=prefix):
        if 'Contents' in result:
            for obj in result['Contents']:
                # S3 객체 키에서 로컬 파일 경로를 생성합니다.
                request_key = obj['Key']
                if request_key.endswith('/'):  # 디렉토리 스킵
                    continue
                # save_path 는 이미 앞서 os.path.join을 통해 결합된 상태라고 가정합니다.
                request_key_formatted = request_key.replace(
                    prefix, '', 1) if request_key.startswith(prefix) else request_key
                local_file_path = os.path.join(
                    local_directory, request_key_formatted.strip('/'))
                local_file_dir = os.path.dirname(local_file_path)

                # 로컬에 해당 경로의 디렉토리가 없다면 생성합니다.
                if not os.path.exists(local_file_dir):
                    os.makedirs(local_file_dir)

                # 파일을 다운로드하고 콘솔에 진행 상황을 표시합니다.
                s3.download_file(bucket_name, request_key, local_file_path)
                print(f"Downloaded {request_key} to {local_file_path}")

# -


def main(class_name):
    cls = class_name

    delete_ipynb()

    clip_model, preprocess = clip.load('ViT-B/32')
    GenerateFeatures_ = GenerateFeatures(clip_model, preprocess, cls_name=cls)
    GenerateFeatures_.generate_features()

    cfg = yaml.load(open(f'configs/{cls}.yaml', 'r'), Loader=yaml.Loader)

    clip_model, _ = clip.load(cfg['backbone'])
    clip_model.eval()
    random.seed(cfg['seed'])
    torch.manual_seed(cfg['seed'])
    clip_weights = load_text_feature(cfg)
    cache_keys, cache_values = load_few_shot_feature(cfg)
    test_features, _ = loda_val_test_feature(cfg, "test")

    result = test(cfg, cache_keys, cache_values,
                  test_features, clip_weights, cls)

    # 추론 이후, 폴더가 존재하는지 확인한 뒤 폴더와 하위 내용물 모두 삭제
    folder_path1 = f'./data/cosmetic/images/test/{cls}'

    if os.path.exists(folder_path1):
        shutil.rmtree(folder_path1)

    folder_path2 = f'./caches/{cls}/'

    # 폴더 내 모든 파일 및 폴더 목록을 얻습니다.
    file_list = os.listdir(folder_path2)

    for file_name in file_list:
        if 'test' in file_name:  # 파일 이름에 'test' 키워드가 포함되어 있는 경우
            file_path = os.path.join(folder_path2, file_name)  # 파일 경로 생성
            if os.path.isfile(file_path):  # 파일인 경우만 삭제
                os.remove(file_path)

    return result


app = Flask(__name__)
CORS(app)


@app.route('/find_cosmetic', methods=['POST'])
def find_cosmetic():
    data = request.get_json()

    class_names = data.get('class_names')
    save_path = data.get('save_path')

    if not class_names or not save_path:
        return jsonify({"error": "Missing class_names or save_path in the request data"}), 400

    if not isinstance(class_names, list):
        return jsonify({"error": "class_names should be a list"}), 400

    bucket_name = 'cosmetic-detector-bucket'
    prefix = os.path.join('.', save_path)
    local_directory = os.getcwd()
    download_directory_from_s3(bucket_name, prefix, local_directory)

    results = []
    seen = set()  # 이미 추가된 조합을 기록하기 위한 set

    for class_name in class_names:
        product_name = main(class_name)
        # (brand_name, product_name) 튜플로 중복을 확인
        if (class_name, product_name) not in seen:
            seen.add((class_name, product_name))  # 새로운 조합을 set에 추가
            result = {'brand_name': class_name, 'product_name': product_name}
            results.append(result)

    return jsonify(results)


if __name__ == "__main__":
    app.run(debug=True, host='0.0.0.0', port=8000)
